<!DOCTYPE html>


















<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Codes - Battman User Manual</title>
    <link href="../../stylesheets/apple-theme.css" rel="stylesheet">
    
    <script>var base_url = "../..";</script>
    
  </head>
  <body class="bm-body">
    <header class="bm-header bm-squircle">
      <div class="bm-header-left">
        <div class="bm-logo">⚡</div>
        <div class="bm-title-block">
          <div class="bm-site-name">Battman User Manual</div>
          <div class="bm-page-title">Codes</div>
        </div>
      </div>
      <div class="bm-header-right">
        <button id="bm-nav-toggle" class="bm-toggle bm-nav-toggle" type="button">Menu</button>
        <button id="bm-theme-toggle" class="bm-toggle" type="button">Theme</button>
        <select id="bm-lang-select" class="bm-select" aria-label="Language">
          <option value="en">English</option>
          <option value="zh">简体中文</option>
        </select>
        
        <form class="bm-search" action="../../search.html">
          <input id="mkdocs-search-query" type="search" name="q" placeholder="Search" />
        </form>
        
      </div>
    </header>

    <div id="bm-nav-overlay" class="bm-nav-overlay"></div>

    <main class="bm-main">
      <aside class="bm-sidebar bm-squircle">
        <nav class="bm-nav">
          <ul class="bm-nav-list">
              <li class="bm-nav-item">
              
                <a href="../.." class="bm-nav-link">Home</a>
              
            </li>
            
              <li class="bm-nav-item">
              
                <div class="bm-nav-section">Installation</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../installation/" class="bm-nav-link">iOS</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../installation/macos/" class="bm-nav-link">macOS</a>
              
            </li>
                  
                </ul>
                
              
            </li>
            
              <li class="bm-nav-item">
              
                <div class="bm-nav-section">Metrics</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../metrics/battery-info/" class="bm-nav-link">Battery Info</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../metrics/hardware-temperature/" class="bm-nav-link">Hardware Temperature</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../metrics/brightness/" class="bm-nav-link">Brightness</a>
              
            </li>
                  
                </ul>
                
              
            </li>
            
              <li class="bm-nav-item">
              
                <div class="bm-nav-section">Controls</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../controls/charging-managements/" class="bm-nav-link">Charging Managements</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../controls/charging-limits/" class="bm-nav-link">Charging Limits</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../controls/thermal-tunes/" class="bm-nav-link">Thermal Tunes</a>
              
            </li>
                  
                </ul>
                
              
            </li>
            
              <li class="bm-nav-item">
              
                <div class="bm-nav-section">Troubleshooting</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <div class="bm-nav-section">Battery Info</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/battery-info/warning-conditions/" class="bm-nav-link">Warning Conditions</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/battery-info/flags/" class="bm-nav-link">Flags</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/battery-info/not-charging-reason/" class="bm-nav-link">Not Charging Reason</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/battery-info/family-keys/" class="bm-nav-link">Family Codes</a>
              
            </li>
                  
                </ul>
                
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <div class="bm-nav-section">Thermals</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/thermals/unknown-screen-temperature/" class="bm-nav-link">'Unknown' Screen Temperature</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/thermals/thermal-notification-levels/" class="bm-nav-link">Thermal Notification Levels</a>
              
            </li>
                  
                </ul>
                
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <div class="bm-nav-section">Screen & Brightness</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/screen-brightness/nits-and-percentages/" class="bm-nav-link">Nits & Percentages</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../troubleshooting/screen-brightness/brightness-backends/" class="bm-nav-link">Brightness Backends</a>
              
            </li>
                  
                </ul>
                
              
            </li>
                  
                </ul>
                
              
            </li>
            
              <li class="bm-nav-item">
              
                <div class="bm-nav-section">Preferences</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../preferences/preferred-languages/" class="bm-nav-link">Preferred Languages</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../preferences/wiping-data/" class="bm-nav-link">Wiping Data</a>
              
            </li>
                  
                </ul>
                
              
            </li>
            
              <li class="bm-nav-item">
              
                <a href="../../uninstallation/" class="bm-nav-link">Uninstallation</a>
              
            </li>
            
              <li class="bm-nav-item bm-nav-item--active">
              
                <div class="bm-nav-section">Contributing</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../locales/" class="bm-nav-link">Locales</a>
              
            </li>
                  
                  <li class="bm-nav-item bm-nav-item--active">
              
                <a href="./" class="bm-nav-link bm-nav-link--active">Codes</a>
              
            </li>
                  
                </ul>
                
              
            </li>
            
              <li class="bm-nav-item">
              
                <div class="bm-nav-section">Updating</div>
                
                <ul class="bm-nav-children">
                  
                  <li class="bm-nav-item">
              
                <a href="../../updating/ios/" class="bm-nav-link">iOS</a>
              
            </li>
                  
                  <li class="bm-nav-item">
              
                <a href="../../updating/macos/" class="bm-nav-link">macOS</a>
              
            </li>
                  
                </ul>
                
              
            </li>
            
          </ul>
        </nav>
      </aside>

      <article class="bm-content bm-squircle">
        <h1 id="contributing-code">Contributing Code<a class="headerlink" href="#contributing-code" title="Permanent link">&para;</a></h1>
<p>We welcome code contributions to Battman.</p>
<h2 id="before-you-start">Before you start<a class="headerlink" href="#before-you-start" title="Permanent link">&para;</a></h2>
<ul>
<li>Read the main <code>README.md</code> for an overview of the project layout and build requirements.</li>
<li>Make sure you have a suitable iOS toolchain and environment set up.</li>
</ul>
<h2 id="project-structure">Project Structure<a class="headerlink" href="#project-structure" title="Permanent link">&para;</a></h2>
<p>Battman is written in <strong>Objective-C and C</strong> (no Swift). The main codebase is organized as follows:</p>
<h3 id="directory-layout">Directory Layout<a class="headerlink" href="#directory-layout" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>Battman/</code></strong> - Main application code</li>
<li><strong><code>battery_utils/</code></strong> - Battery information and hardware interaction utilities</li>
<li><strong><code>hw/</code></strong> - Hardware-specific interfaces (e.g., IOMFB)</li>
<li><strong><code>cobjc/</code></strong> - Custom Objective-C runtime wrappers for C compatibility</li>
<li><strong><code>ObjCExt/</code></strong> - Objective-C category extensions</li>
<li><strong><code>CGIconSet/</code></strong> - Custom icon generation code</li>
<li><strong><code>brightness/</code></strong> - Brightness control functionality</li>
<li><strong><code>scprefs/</code></strong> - Preferences integration</li>
<li><strong><code>security/</code></strong> - Security and protection code</li>
</ul>
<h3 id="file-naming-conventions">File Naming Conventions<a class="headerlink" href="#file-naming-conventions" title="Permanent link">&para;</a></h3>
<ul>
<li>View controllers: <code>*ViewController.h</code> / <code>*ViewController.m</code></li>
<li>Custom views: <code>*View.h</code> / <code>*View.m</code> or <code>*Cell.h</code> / <code>*Cell.m</code></li>
<li>C headers: <code>*.h</code> with corresponding <code>*.c</code> or <code>*.m</code> implementations</li>
<li>Headers use <code>#pragma once</code> or traditional include guards</li>
</ul>
<h2 id="code-style-guidelines">Code Style Guidelines<a class="headerlink" href="#code-style-guidelines" title="Permanent link">&para;</a></h2>
<h3 id="language-and-architecture">Language and Architecture<a class="headerlink" href="#language-and-architecture" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Primary languages</strong>: Objective-C and C</li>
<li><strong>No external dependencies</strong>: No CocoaPods, Swift Packages, or third-party frameworks</li>
<li><strong>No Storyboards or XIBs</strong>: UI is built programmatically</li>
<li><strong>No Xcode Assets</strong>: Resources are generated programmatically</li>
</ul>
<h4 id="why-no-xcode-assets-and-storyboards">Why No Xcode Assets and Storyboards?<a class="headerlink" href="#why-no-xcode-assets-and-storyboards" title="Permanent link">&para;</a></h4>
<p>Battman does not use Xcode Assets (.xcassets) or Storyboards/XIBs for the following reasons:</p>
<ul>
<li>
<p><strong>Open-source toolchain compatibility</strong>: Those formats are private commercial formats made by Apple, which are not buildable with open-source toolchains. This prevents the project from being built on non-Apple platforms or with alternative build systems.</p>
</li>
<li>
<p><strong>Cross-platform collaboration</strong>: We have collaborators not using macOS and Xcode. Using those formats will break the maintainability and prevent contributors from working on the project in their preferred environments.</p>
</li>
<li>
<p><strong>Programmatic UI preference</strong>: We always prefer writing UI programmatically, instead of predefining them in some sort of files. This approach provides better version control, easier code review, and more flexibility in UI construction.</p>
</li>
</ul>
<h4 id="why-no-third-party-dependencies">Why No Third-Party Dependencies?<a class="headerlink" href="#why-no-third-party-dependencies" title="Permanent link">&para;</a></h4>
<p>Battman intentionally avoids third-party dependencies (CocoaPods, Swift Packages, external frameworks) for the following reasons:</p>
<ul>
<li>
<p><strong>Control and maintainability</strong>: External code is not under our control, and we cannot respond to potential future changes, breaking updates, or deprecations that may affect the project.</p>
</li>
<li>
<p><strong>Collaboration accessibility</strong>: Not every collaborator is able to pull such dependencies on their build systems. Avoiding external dependencies ensures that all contributors can build and work on the project regardless of their environment setup, facilitating better collaboration.</p>
</li>
</ul>
<p>If you need functionality that would typically come from a third-party library, please implement it directly in the codebase or adapt the necessary code to fit Battman's architecture (For example, we have completely rewritten Swift <code>UberSegmentedControl</code> in Objective-C).</p>
<h4 id="why-no-swift-code">Why No Swift Code?<a class="headerlink" href="#why-no-swift-code" title="Permanent link">&para;</a></h4>
<p>Battman uses Objective-C and C exclusively, and does not accept Swift code submissions for the following reasons:</p>
<ul>
<li>
<p><strong>Stability and compatibility</strong>: Swift itself has frequent updates with breaking changes, and is always trying to drop support for previous system versions. This creates maintenance burden and compatibility issues that conflict with Battman's goal of supporting iOS 12+.</p>
</li>
<li>
<p><strong>Toolchain size</strong>: The Swift toolchain is much larger than regular LLVM + Clang, which is not friendly for our existing collaborators who may have limited resources or prefer minimal toolchain installations.</p>
</li>
<li>
<p><strong>Exception for unavoidable Swift</strong>: If your submission is not Swift-avoidable (for example, WidgetKit only allows Swift), please create a new subproject to contain it. Otherwise, all logic and UI should be written in Objective-C and C.</p>
</li>
</ul>
<p>If you must use Swift, your Swift code must meet these requirements:
  - Your Swift code should have been compiled and tested on iOS 12 or earlier.
  - Your Swift code should be written in Swift 4 or older.
  - Your Swift code should at least be buildable with Procursus' Swift toolchain on iOS.</p>
<h3 id="c-objective-c-patterns">C / Objective-C Patterns<a class="headerlink" href="#c-objective-c-patterns" title="Permanent link">&para;</a></h3>
<h4 id="singleton-pattern">Singleton Pattern<a class="headerlink" href="#singleton-pattern" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">sharedPrefs</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">BattmanPrefs</span><span class="w"> </span><span class="o">*</span><span class="n">shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">nil</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">dispatch_once_t</span><span class="w"> </span><span class="n">onceToken</span><span class="p">;</span>
<span class="w">    </span><span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="p">{</span>
<span class="w">        </span><span class="n">shared</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="nb">self</span><span class="w"> </span><span class="n">alloc</span><span class="p">]</span><span class="w"> </span><span class="n">_init</span><span class="p">];</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">shared</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="ios-version-checks">iOS Version Checks<a class="headerlink" href="#ios-version-checks" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(@</span><span class="n">available</span><span class="p">(</span><span class="n">iOS</span><span class="w"> </span><span class="mf">13.0</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// iOS 13+ code</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fallback code</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_available</span><span class="p">(</span><span class="n">iOS</span><span class="w"> </span><span class="mf">13.0</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// iOS 13+ code</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Fallback code</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="debug-logging">Debug Logging<a class="headerlink" href="#debug-logging" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// DBGLOG is based on NSLog()</span>
<span class="n">DBGLOG</span><span class="p">(</span><span class="n">CFSTR</span><span class="p">(</span><span class="s">&quot;Debug message: %@&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">// DBGLOG is based on NSLog()</span>
<span class="n">DBGLOG</span><span class="p">(</span><span class="s">@&quot;Debug message: %@&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
</code></pre></div>

<h4 id="localization">Localization<a class="headerlink" href="#localization" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// For NSString</span>
<span class="n">NSString</span><span class="w"> </span><span class="o">*</span><span class="n">localized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_</span><span class="p">(</span><span class="s">&quot;String to localize&quot;</span><span class="p">);</span>

<span class="c1">// For C strings</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">localized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_C</span><span class="p">(</span><span class="s">&quot;String to localize&quot;</span><span class="p">);</span>
</code></pre></div>

<h4 id="static-initialization">Static Initialization<a class="headerlink" href="#static-initialization" title="Permanent link">&para;</a></h4>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">dispatch_once_t</span><span class="w"> </span><span class="n">onceToken</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>

<span class="n">dispatch_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">onceToken</span><span class="p">,</span><span class="w"> </span><span class="o">^</span><span class="p">{</span>
<span class="w">    </span><span class="c1">// One-time initialization</span>
<span class="w">    </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_value</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>

<h3 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h3>
<ul>
<li>Check return values from system calls</li>
<li>Use <code>os_log_error</code> for error conditions</li>
<li>Provide fallback paths when possible</li>
<li>Avoid crashing on recoverable errors</li>
</ul>
<h3 id="memory-management">Memory Management<a class="headerlink" href="#memory-management" title="Permanent link">&para;</a></h3>
<ul>
<li>Use ARC for Objective-C code</li>
<li>Manual memory management for C code (free what you malloc)</li>
<li>Be careful with CF types - use <code>CFRelease</code> appropriately</li>
</ul>
<h3 id="build-system">Build System<a class="headerlink" href="#build-system" title="Permanent link">&para;</a></h3>
<p>Battman can be built with:
- <strong>Xcode</strong>: Standard Xcode project
- <strong>Makefile</strong>: Located in <code>Battman/Makefile</code>, supports Linux builds</p>
<p>Key build flags:
- <code>-fobjc-arc</code>: Automatic Reference Counting
- <code>-target arm64-apple-ios12.0</code>: iOS 12+ deployment target
- <code>-DDEBUG</code>: Debug builds
- <code>-DUSE_GETTEXT</code>: Optional gettext localization support</p>
<h2 id="typical-workflow">Typical workflow<a class="headerlink" href="#typical-workflow" title="Permanent link">&para;</a></h2>
<ol>
<li>Fork the repository and create a feature branch.</li>
<li>Make your changes with clear, focused commits.</li>
<li>Prefer small, reviewable pull requests rather than large, mixed ones.</li>
<li>Test on as many relevant iOS versions / devices as you can.</li>
<li>Open a pull request and describe:</li>
<li>What you changed.</li>
<li>How you tested it.</li>
<li>Any user‑visible behavior differences.</li>
</ol>
<h2 id="code-review-guidelines">Code Review Guidelines<a class="headerlink" href="#code-review-guidelines" title="Permanent link">&para;</a></h2>
<ul>
<li>Follow existing code style and patterns</li>
<li>Maintain compatibility with iOS 12+</li>
<li>Test on both simulator and real devices when possible</li>
<li>Use appropriate logging (DBGLOG for debug, os_log for production)</li>
<li>Ensure proper memory management</li>
<li>Add comments for complex logic or hardware-specific code</li>
<li>Update related documentation if behavior changes</li>
</ul>
<p>Please avoid introducing private information (such as personal certificates or keys) into the repository or build scripts.</p>
      </article>

      
      <aside class="bm-toc bm-squircle">
        <div class="bm-toc-title">On this page</div>
        <ul class="bm-toc-list">
          
          <li class="bm-toc-item">
            <a href="#contributing-code">Contributing Code</a>
            
            <ul class="bm-toc-sublist">
              
              <li class="bm-toc-subitem"><a href="#before-you-start">Before you start</a></li>
              
              <li class="bm-toc-subitem"><a href="#project-structure">Project Structure</a></li>
              
              <li class="bm-toc-subitem"><a href="#code-style-guidelines">Code Style Guidelines</a></li>
              
              <li class="bm-toc-subitem"><a href="#typical-workflow">Typical workflow</a></li>
              
              <li class="bm-toc-subitem"><a href="#code-review-guidelines">Code Review Guidelines</a></li>
              
            </ul>
            
          </li>
          
        </ul>
      </aside>
      
    </main>

    <footer class="bm-footer">
      <div class="bm-footer-inner">
        <span>© Battman User Manual</span>
      </div>
    </footer>
    <script src="../../javascripts/apple-theme.js"></script>
    <script src="../../search/main.js"></script>
  </body>
</html>